# å®‰è£…é—®é¢˜è§£å†³æ–¹æ¡ˆï¼šfilterpy å’Œ openai-clip ç¼–è¯‘é”™è¯¯

## é—®é¢˜åˆ†æ

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Building wheel for filterpy (pyproject.toml) ... error
exit code: -9
Building wheel for openai-clip (pyproject.toml) ... error
exit code: -9
```

**åŸå› ï¼š**
- `exit code: -9` é€šå¸¸è¡¨ç¤ºè¿›ç¨‹è¢«ç³»ç»Ÿkillï¼Œå¯èƒ½æ˜¯ï¼š
  1. **å†…å­˜ä¸è¶³ï¼ˆOOMï¼‰** - ç¼–è¯‘æ—¶å†…å­˜è€—å°½
  2. **ç¼–è¯‘è¶…æ—¶** - ç¼–è¯‘æ—¶é—´è¿‡é•¿
  3. **ç¼ºå°‘ç¼–è¯‘å·¥å…·** - ç¼ºå°‘C/C++ç¼–è¯‘å™¨

è¿™äº›åŒ…æ˜¯ `clip-score` çš„ä¾èµ–ï¼Œç”¨äºCLIPScoreè¯„ä¼°ã€‚

---

## è§£å†³æ–¹æ¡ˆ

### âœ… æ–¹æ¡ˆ1ï¼šä½¿ç”¨é¢„ç¼–è¯‘çš„wheelåŒ…ï¼ˆæ¨èï¼‰

å°è¯•ä½¿ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶åŒ…ï¼Œé¿å…ç¼–è¯‘ï¼š

```bash
# å…ˆå°è¯•å®‰è£…é¢„ç¼–è¯‘ç‰ˆæœ¬
pip install --only-binary=all filterpy openai-clip

# å¦‚æœä¸Šé¢å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬
pip install filterpy==1.4.5  # ä½¿ç”¨è¾ƒæ—§ä½†ç¨³å®šçš„ç‰ˆæœ¬
pip install openai-clip==1.0  # æˆ–å°è¯•å…¶ä»–ç‰ˆæœ¬
```

### âœ… æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ›¿ä»£çš„CLIPå®ç°ï¼ˆæœ€ç®€å•ï¼‰

**ä¸ä½¿ç”¨ `clip-score`ï¼Œæ”¹ç”¨ `clip` åº“ï¼š**

```bash
# å®‰è£…OpenAIçš„å®˜æ–¹CLIPåº“ï¼ˆæ›´ç¨³å®šï¼‰
pip install git+https://github.com/openai/CLIP.git

# æˆ–è€…ä½¿ç”¨torchç‰ˆæœ¬çš„CLIP
pip install torch torchvision
pip install ftfy regex tqdm
```

**ç„¶åè‡ªå·±å®ç°CLIPScoreï¼š**

```python
import torch
import clip
from PIL import Image

# åŠ è½½CLIPæ¨¡å‹
device = "cuda" if torch.cuda.is_available() else "cpu"
model, preprocess = clip.load("ViT-B/32", device=device)

def calculate_clipscore(image_path: str, text: str) -> float:
    """è®¡ç®—CLIPScore"""
    # åŠ è½½å’Œé¢„å¤„ç†å›¾åƒ
    image = preprocess(Image.open(image_path)).unsqueeze(0).to(device)
    
    # ç¼–ç æ–‡æœ¬
    text_tokens = clip.tokenize([text]).to(device)
    
    # è®¡ç®—ç›¸ä¼¼åº¦
    with torch.no_grad():
        image_features = model.encode_image(image)
        text_features = model.encode_text(text_tokens)
        
        # å½’ä¸€åŒ–
        image_features = image_features / image_features.norm(dim=-1, keepdim=True)
        text_features = text_features / text_features.norm(dim=-1, keepdim=True)
        
        # è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
        similarity = (image_features @ text_features.T).item()
    
    return similarity
```

### âœ… æ–¹æ¡ˆ3ï¼šè·³è¿‡CLIPScoreï¼Œä½¿ç”¨å…¶ä»–æŒ‡æ ‡

**å¦‚æœä¸éœ€è¦CLIPScoreï¼Œç›´æ¥ä½¿ç”¨LPIPSå’ŒIQA-PyTorchï¼š**

```bash
# åªå®‰è£…è¿™äº›ï¼ˆä¸éœ€è¦ç¼–è¯‘ï¼‰
pip install lpips
pip install pyiqa
```

è¿™äº›åŒ…éƒ½æœ‰é¢„ç¼–è¯‘çš„wheelï¼Œä¸éœ€è¦ç¼–è¯‘ã€‚

### âœ… æ–¹æ¡ˆ4ï¼šå¢åŠ ç¼–è¯‘èµ„æº

å¦‚æœå¿…é¡»ç¼–è¯‘ï¼Œå°è¯•ï¼š

```bash
# 1. å¢åŠ å†…å­˜é™åˆ¶ï¼ˆå¦‚æœä½¿ç”¨Dockerï¼‰
# 2. ä½¿ç”¨æ›´å°‘çš„å¹¶è¡Œç¼–è¯‘
export MAX_JOBS=1
pip install filterpy openai-clip

# 3. æˆ–è€…å•ç‹¬å®‰è£…ï¼Œå‡å°‘å†…å­˜å‹åŠ›
pip install filterpy
pip install openai-clip
```

### âœ… æ–¹æ¡ˆ5ï¼šä½¿ç”¨condaï¼ˆå¦‚æœæœ‰condaç¯å¢ƒï¼‰

```bash
# condaé€šå¸¸æœ‰é¢„ç¼–è¯‘çš„åŒ…
conda install -c conda-forge filterpy
conda install -c conda-forge openai-clip
```

---

## æ¨èæ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### ğŸ¥‡ æ–¹æ¡ˆ1ï¼šè·³è¿‡CLIPScoreï¼Œä½¿ç”¨LPIPSï¼ˆæœ€æ¨èï¼‰

**åŸå› ï¼š**
- âœ… LPIPSå¯ä»¥ç›´æ¥pip installï¼Œæ— éœ€ç¼–è¯‘
- âœ… æ„ŸçŸ¥ç›¸ä¼¼åº¦è¯„ä¼°ï¼Œå‡†ç¡®æ€§é«˜
- âœ… æ— éœ€å‚è€ƒè§†é¢‘ï¼Œä½¿ç”¨ç®€å•

**å®‰è£…ï¼š**
```bash
pip install lpips
```

**ä½¿ç”¨ï¼š**
```python
import lpips

loss_fn = lpips.LPIPS()
# è®¡ç®—æ„ŸçŸ¥ç›¸ä¼¼åº¦
distance = loss_fn(img0, img1)
```

### ğŸ¥ˆ æ–¹æ¡ˆ2ï¼šä½¿ç”¨å®˜æ–¹CLIPåº“

**å®‰è£…ï¼š**
```bash
pip install git+https://github.com/openai/CLIP.git
```

**ä¼˜ç‚¹ï¼š**
- âœ… å®˜æ–¹ç»´æŠ¤ï¼Œæ›´ç¨³å®š
- âœ… é€šå¸¸æœ‰é¢„ç¼–è¯‘ç‰ˆæœ¬
- âœ… åŠŸèƒ½å®Œæ•´

### ğŸ¥‰ æ–¹æ¡ˆ3ï¼šä½¿ç”¨IQA-PyTorchï¼ˆåŒ…å«å¤šç§æŒ‡æ ‡ï¼‰

**å®‰è£…ï¼š**
```bash
pip install pyiqa
```

**ä¼˜ç‚¹ï¼š**
- âœ… åŒ…å«å¤šç§è´¨é‡è¯„ä¼°æŒ‡æ ‡
- âœ… ç»Ÿä¸€API
- âœ… é¢„ç¼–è¯‘åŒ…ï¼Œæ— éœ€ç¼–è¯‘

---

## å¿«é€Ÿè§£å†³æ–¹æ¡ˆ

### å¦‚æœä½ ä¸éœ€è¦CLIPScoreï¼š

```bash
# åªå®‰è£…è¿™äº›ï¼ˆæ¨èï¼‰
pip install lpips pyiqa
```

### å¦‚æœä½ éœ€è¦CLIPScoreï¼š

```bash
# ä½¿ç”¨å®˜æ–¹CLIPåº“
pip install git+https://github.com/openai/CLIP.git
```

ç„¶åä½¿ç”¨ä¸Šé¢çš„Pythonä»£ç è‡ªå·±å®ç°CLIPScoreè®¡ç®—ã€‚

---

## æ›´æ–°åçš„æ¨èå®‰è£…å‘½ä»¤

### æœ€æ¨èçš„ç»„åˆï¼ˆæ— éœ€ç¼–è¯‘ï¼‰ï¼š

```bash
# åŸºç¡€ä¾èµ–
pip install opencv-python numpy matplotlib

# è§†é¢‘è´¨é‡è¯„ä¼°ï¼ˆæ— éœ€ç¼–è¯‘ï¼‰
pip install lpips pyiqa

# å¦‚æœéœ€è¦CLIPåŠŸèƒ½ï¼Œä½¿ç”¨å®˜æ–¹åº“
pip install git+https://github.com/openai/CLIP.git
```

### é¿å…å®‰è£…çš„åŒ…ï¼š

```bash
# è¿™äº›åŒ…éœ€è¦ç¼–è¯‘ï¼Œå¯èƒ½å¤±è´¥
# pip install clip-score  # âŒ ä¾èµ–filterpyå’Œopenai-clip
```

---

## æµ‹è¯•å®‰è£…

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
python test_advanced_metrics.py
```

è¿™ä¼šæ£€æŸ¥å“ªäº›æ¡†æ¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

---

## æ€»ç»“

**é—®é¢˜ï¼š** `filterpy` å’Œ `openai-clip` ç¼–è¯‘å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
1. **æœ€ç®€å•**ï¼šè·³è¿‡CLIPScoreï¼Œä½¿ç”¨LPIPS
2. **å¦‚æœéœ€è¦CLIP**ï¼šä½¿ç”¨å®˜æ–¹CLIPåº“
3. **å¦‚æœå¿…é¡»ç¼–è¯‘**ï¼šå¢åŠ å†…å­˜ï¼Œå‡å°‘å¹¶è¡Œåº¦

**æ¨èï¼š** ä½¿ç”¨ `lpips` + `pyiqa`ï¼Œè¿™ä¸¤ä¸ªåŒ…éƒ½æœ‰é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼Œæ— éœ€ç¼–è¯‘ã€‚

